name: Deploy Hexo to External Pages Repository

on:
  push:
    branches:
      - main
    paths:
      - 'source/**'
      - 'themes/**'
      - '_config.yml'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. æ£€å‡ºæºä»£ç ï¼ˆåŒ…å«å­æ¨¡å—ï¼‰
      - name: Checkout Repository with Submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: 'recursive'
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½®Node.jsç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.21.1'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      # 3. ç¼“å­˜ä¾èµ–åŠ é€Ÿæ„å»º
      - name: Cache NPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4. å®‰è£…ä¾èµ–å¹¶æ„å»ºHexoç«™ç‚¹
      - name: Install Dependencies and Build
        run: |
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          
          # æ¸…ç†å¯èƒ½çš„ç¼“å­˜
          npm cache clean --force
          
          # å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ciç¡®ä¿ä¸€è‡´æ€§ï¼‰
          npm ci --include=dev
          
          # Hexoæ„å»º
          npx hexo clean
          npx hexo generate
          
          # éªŒè¯ç”Ÿæˆçš„æ–‡ä»¶
          echo "=== Generated static files ==="
          du -sh ./public
          ls -la ./public | head -10
          echo "============================="

      # 5. éƒ¨ç½²åˆ°å¤–éƒ¨hskt_pagesä»“åº“
      - name: Deploy to hskt_pages Repository
        uses: peaceiris/actions-gh-pages@v3.9.3
        with:
          # ä½¿ç”¨éƒ¨ç½²å¯†é’¥è®¿é—®å¤–éƒ¨ä»“åº“ï¼ˆæ¨èæ–¹å¼ï¼‰
          deploy_key: ${{ secrets.HSKT_PAGES_DEPLOY_KEY }}
          
          # å¤–éƒ¨ä»“åº“é…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„ç”¨æˆ·åå’Œä»“åº“åï¼‰
          external_repository: gitychzh/hskt_pages
          
          # å‘å¸ƒé…ç½®
          publish_branch: main          # ç›®æ ‡åˆ†æ”¯
          publish_dir: ./public         # æºç›®å½•
          
          # æäº¤ä¿¡æ¯é…ç½®
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: |
            Deploy from source repository
            Commit: ${{ github.event.head_commit.message || github.sha }}
            Triggered by: ${{ github.actor }}
            Date: ${{ github.event.head_commit.timestamp }}
          
          # éƒ¨ç½²ç­–ç•¥
          force_orphan: false           # ä¿ç•™å†å²æäº¤
          keep_files: false             # ä¸ä¿ç•™æ—§æ–‡ä»¶
          allow_empty_commit: false     # æ²¡æœ‰å˜æ›´æ—¶ä¸æäº¤
          
          # è°ƒè¯•ä¿¡æ¯
          enable_jekyll: false          # GitHub Pagesçš„Jekyllå¤„ç†
          cname: ''                     # å¦‚æœ‰è‡ªå®šä¹‰åŸŸåè¯·åœ¨æ­¤å¡«å†™

      # 6. éƒ¨ç½²å®Œæˆé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼ç«™ç‚¹å·²æ›´æ–°åˆ° hskt_pages ä»“åº“ã€‚"
            echo "ğŸ“Š å¯ä»¥åœ¨ https://ä½ çš„ç”¨æˆ·å.github.io/hskt_pages/ è®¿é—®"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯ã€‚"
            exit 1
          fi

      # 7. æ¸…ç†ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
      - name: Cleanup
        if: always()
        run: |
          echo "æ¸…ç†å·¥ä½œç©ºé—´..."
          rm -rf node_modules
          rm -rf ./.git